# WhatsApp AI智能客服RAG聊天机器人 - 操作指南

## 📋 项目概述

基于 n8n v1.101.1 的WhatsApp智能客服解决方案，集成RAG技术和OpenAI GPT模型，为电子产品商店提供自动化客户服务。

## 🏗️ 系统架构

```
WhatsApp Business API → n8n工作流 → OpenAI GPT-4o-mini
                           ↓
                    Qdrant向量数据库 ← Google Drive文档
```

## ✨ 核心功能

- 🤖 智能对话：基于OpenAI的自然语言处理
- 📚 知识检索：RAG技术精准检索企业知识库
- 💬 WhatsApp集成：原生支持WhatsApp Business API
- 🧠 上下文记忆：保持对话连续性
- 📁 文档管理：Google Drive文档自动向量化

## 🛠️ 技术栈

| 组件 | 技术 | 版本 |
|------|------|------|
| 工作流引擎 | n8n | 1.101.1 |
| 大语言模型 | OpenAI GPT | 4o-mini |
| 向量数据库 | Qdrant | Latest |
| 文档存储 | Google Drive | API v3 |
| 消息平台 | WhatsApp Business | API |

## 🚀 快速部署

### 1. 环境准备

```bash
# 安装n8n
npm install -g n8n@1.101.1

# 启动n8n
n8n start
# 访问 http://localhost:5678
```

### 2. 必需的API密钥

1. **OpenAI API Key** - [获取地址](https://platform.openai.com/api-keys)
2. **Meta开发者账号** - [注册地址](https://developers.facebook.com/)
3. **Qdrant数据库** - 部署Qdrant实例
4. **Google Drive API** - [控制台地址](https://console.cloud.google.com/)

### 3. 配置凭据

在n8n中添加以下凭据：
- OpenAI (API Key)
- WhatsApp Business (Access Token + Phone Number ID)
- HTTP Header Auth (Qdrant API Key)
- Google Drive (Service Account 或 OAuth2)

### 4. 导入模板

1. 下载模板文件：`WhatsApp智能客服中文版.json`
2. 在n8n中选择 "Import from file"
3. 上传JSON文件并导入

### 5. 配置参数

**修改Qdrant URL和集合名称**：
- 创建集合节点：`https://你的QDRANT地址/collections/你的集合名称`
- 刷新集合节点：`https://你的QDRANT地址/collections/你的集合名称/points/delete`

**配置Google Drive**：
- 设置包含知识库文档的文件夹ID

**配置WhatsApp**：
- 设置正确的Phone Number ID

### 6. 设置Webhook

1. 获取n8n中"验证"节点的Webhook URL
2. 在Meta开发者控制台配置：
   - Callback URL: 你的Webhook URL
   - Verify Token: 与n8n中设置的相同
   - Webhook Fields: 选择 `messages`

### 7. 准备知识库

在Google Drive中组织文档：
```
知识库/
├── 产品手册/
├── 故障排除/
└── 政策文档/
```

### 8. 向量化文档

点击"点击测试工作流"节点，系统将：
- 创建Qdrant集合
- 下载Google Drive文档
- 分割并向量化文档
- 存储到Qdrant数据库

### 9. 测试系统

向配置的WhatsApp号码发送测试消息，验证AI回复。

## 🔧 自定义配置

### AI助手系统提示

可在"AI智能助手"节点中自定义系统提示：

```
您是一个[您的行业]的AI智能助手。您的主要目标是...

指导原则：
1. 专业知识：深入了解[您的产品/服务]
2. 客户服务：提供友好、准确的支持
3. 问题解决：提供具体的解决方案
```

### 优化检索参数

调整文档分块参数：
```json
{
  "chunkSize": 500,
  "chunkOverlap": 50
}
```

## 🐛 常见问题

### Webhook验证失败
```bash
# 测试Webhook
curl -X GET "你的webhook地址?hub.verify_token=你的token&hub.challenge=test123"
```

### 向量检索不准确
- 调整score_threshold
- 优化文档分块策略
- 改进查询向量质量

### OpenAI API调用失败
- 检查API密钥有效性
- 确认账户余额
- 验证请求格式

## 📈 系统监控

### 执行监控
```javascript
const executionId = $execution.id;
console.log(`执行开始: ${executionId}`);
```

### 错误处理
```javascript
try {
  // 主要业务逻辑
} catch (error) {
  console.error('工作流执行错误:', error);
  return { response: '抱歉，系统暂时繁忙，请稍后再试。' };
}
```

## 🔒 安全建议

1. 使用HTTPS部署Webhook
2. 定期轮换API密钥
3. 实现请求限流
4. 验证Webhook签名
5. 敏感信息加密存储

## 📝 维护任务

### 每日检查
- 监控系统状态
- 检查错误日志
- 验证API配额

### 每周任务
- 更新知识库
- 分析对话质量
- 优化检索效果

### 每月维护
- 系统性能评估
- 安全检查
- 备份数据

## 📞 技术支持

如遇问题，可参考：
1. [n8n官方文档](https://docs.n8n.io/)
2. [项目GitHub仓库](https://github.com/your-repo)
3. 联系技术支持团队

---

**祝您使用愉快！🎉** 